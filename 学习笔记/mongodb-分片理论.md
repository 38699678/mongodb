## mongodb分片集群 

#### 为什么要用分片集群
- 数据量日益增大，访问性能日渐降低
- 新品上线异常火爆，如何支撑更多的并发用户
- 单库已有100TB数据，恢复需要1-2天
- 地理分布数据
  
#### 分片集群架构图
![avatar](img/分片集群.jpg)

#### 分片集群特点
- 应用全透明，无特殊处理
- 数据自动均衡
- 动态扩容，无须下线
- 提供三种分片方式
  - 基于范围
    ![avatar](img/范围.jpg)
  - 基于hash
    ![avatar](img/hash.jpg)
  - 基于zone/tag
    ![avatar](img/zone.jpg)

#### 分片集群设计
- 合理的架构
  - 是否需要分片
    - 数据量不超过3TB，尽可能保持在2TB一个片
    - 常用索引必须容纳进内存
  - 需要多少分片
    - A=所需存储总量/单服务器可挂载容量   8TB/2TB = 4
    - B=工作集大小/单服务器内存容量    400GB/（256GB*0.6）=3 0.6为最大占用内存比例。400GB为单表数据大小，256GB为物理内存
    - C=并发量总数/（单服务器并发量*0.7） 30000/(9000*0.7) 
    - 分片数量= max(A, B, C) = 6
  - 数据分布规则
    - 是否需要跨机房分布分片
    - 是否需要容灾
    - 高可用的要求如何 
- 正确的姿势
  - 分片概念：
    - 片键shard key：文档中一个字段
    - 文档doc：包含shard key的一行数据
    - 块chunk：包含n个文档
    - 分片shard：包含n个chunk
    - 集群cluster：包含n个分片

  - 选择需要分片的表
  - 选择正确的片键
    - 取值基数，取值基数要大
    - 取值分布：取值分布应尽可能均匀
    - 分散写，集中读
    - 被尽可能多的业务场景用到
    - 避免单调递增或递减的片键 
  
  - 使用合适的均衡策略
- 足够的资源
  - cpu
  - ram
  - 存储
  - 如果以上资源达到60%考虑分片
